<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{giftorder/layout}">
<head>
    <title>ì„ ë¬¼ì„¸íŠ¸ ì„ íƒ</title>
</head>
<body>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{giftorder/layout}">
<head>
    <title>ì„ ë¬¼ì„¸íŠ¸ ì„ íƒ</title>
    <style>
        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .toast {
            position: fixed;
            top: 90px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc3545;
        }

        .toast-icon {
            display: inline-block;
            margin-right: 8px;
        }

        /* ì¥ë°”êµ¬ë‹ˆ ê°œìˆ˜ ì• ë‹ˆë©”ì´ì…˜ */
        .cart-count-animation {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ë²„íŠ¼ ë¡œë”© ìƒíƒœ */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }

        .btn-loading .original-text {
            opacity: 0;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast" class="toast">
        <span class="toast-icon">âœ“</span>
        <span class="toast-message"></span>
    </div>

    <div class="customer-info">
        <span th:text="${customer.name}">í™ê¸¸ë™</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
        (<span th:text="${customer.phone}">010-1234-5678</span>)
    </div>

    <div class="content">
        <div class="products">
            <!-- ê°ˆë¹„ ì„ ë¬¼ì„¸íŠ¸ -->
            <div class="product-card">
                <img src="/images/galbi-set.jpg" alt="ê°ˆë¹„ ì„ ë¬¼ì„¸íŠ¸" class="product-image"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="product-image-placeholder" style="display:none;">ğŸ¥©</div>

                <div class="product-info">
                    <div class="product-name">í”„ë¦¬ë¯¸ì—„ ê°ˆë¹„ ì„ ë¬¼ì„¸íŠ¸</div>
                    <div class="product-description">ìµœê³ ê¸‰ í•œìš° ê°ˆë¹„ë¡œ ë§Œë“  í”„ë¦¬ë¯¸ì—„ ì„ ë¬¼ì„¸íŠ¸ì…ë‹ˆë‹¤. ëª…ì ˆê³¼ íŠ¹ë³„í•œ ë‚  ì„ ë¬¼ë¡œ ì™„ë²½í•©ë‹ˆë‹¤.</div>
                    <div class="product-price">50,000ì›</div>

                    <!-- ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìˆ˜ëŸ‰ í‘œì‹œ -->
                    <div class="cart-status" id="galbi-cart-status" style="display:none;">
                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆì— <span id="galbi-cart-count">0</span>ê°œ ë‹´ê¹€
                    </div>

                    <div class="quantity-controls">
                        <span class="quantity-label">ì¶”ê°€ ìˆ˜ëŸ‰</span>
                        <div class="quantity-selector">
                            <button type="button" class="quantity-btn" onclick="decreaseQuantity('galbi')">-</button>
                            <span class="quantity-display" id="galbi-quantity">0</span>
                            <button type="button" class="quantity-btn" onclick="increaseQuantity('galbi')">+</button>
                        </div>
                    </div>

                    <button class="add-to-cart" onclick="addToCart('galbi')" id="galbi-add-btn" disabled>
                        <span class="original-text">ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€</span>
                    </button>
                </div>
            </div>

            <!-- ìŠ¤íŒ¸ ì„ ë¬¼ì„¸íŠ¸ -->
            <div class="product-card">
                <img src="/images/spam-set.jpg" alt="ìŠ¤íŒ¸ ì„ ë¬¼ì„¸íŠ¸" class="product-image"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="product-image-placeholder" style="display:none;">ğŸ¥«</div>

                <div class="product-info">
                    <div class="product-name">í”„ë¦¬ë¯¸ì—„ ìŠ¤íŒ¸ ì„ ë¬¼ì„¸íŠ¸</div>
                    <div class="product-description">ì •ì„±ìŠ¤ëŸ½ê²Œ ì„ ë³„í•œ í”„ë¦¬ë¯¸ì—„ ìŠ¤íŒ¸ ì„ ë¬¼ì„¸íŠ¸ì…ë‹ˆë‹¤. ì‹¤ìš©ì ì´ê³  ë§›ìˆëŠ” ì„ ë¬¼ì…ë‹ˆë‹¤.</div>
                    <div class="product-price">30,000ì›</div>

                    <!-- ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìˆ˜ëŸ‰ í‘œì‹œ -->
                    <div class="cart-status" id="spam-cart-status" style="display:none;">
                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆì— <span id="spam-cart-count">0</span>ê°œ ë‹´ê¹€
                    </div>

                    <div class="quantity-controls">
                        <span class="quantity-label">ì¶”ê°€ ìˆ˜ëŸ‰</span>
                        <div class="quantity-selector">
                            <button type="button" class="quantity-btn" onclick="decreaseQuantity('spam')">-</button>
                            <span class="quantity-display" id="spam-quantity">0</span>
                            <button type="button" class="quantity-btn" onclick="increaseQuantity('spam')">+</button>
                        </div>
                    </div>

                    <button class="add-to-cart" onclick="addToCart('spam')" id="spam-add-btn" disabled>
                        <span class="original-text">ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="cart-footer">
        <div class="cart-info">
            ì¥ë°”êµ¬ë‹ˆ: <span id="cart-count">0</span>ê°œ ìƒí’ˆ
        </div>
        <button class="go-cart-btn" onclick="location.href='/cart'" id="cart-btn" disabled>
            ì¥ë°”êµ¬ë‹ˆ ë³´ê¸°
        </button>
    </div>
</div>

<script layout:fragment="scripts">
    let cart = { galbi: 0, spam: 0 };
    let quantities = { galbi: 0, spam: 0 };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ì™€ ë™ê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
        syncCartWithServer();
    });

    function syncCartWithServer() {
        console.log("=== ì„œë²„ì™€ ì¥ë°”êµ¬ë‹ˆ ë™ê¸°í™” ===");

        fetch('/api/cart/status')
            .then(response => {
                if (response.status === 401) {
                    // ì¸ì¦ ì˜¤ë¥˜ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    console.log("ì„œë²„ì—ì„œ ë°›ì€ ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°:", data);

                    cart.galbi = data.galbiQuantity || 0;
                    cart.spam = data.spamQuantity || 0;

                    console.log("ë™ê¸°í™”ëœ cart:", cart);

                    updateCartDisplay();
                    updateCartStatusDisplay();
                    updateQuantityDisplay('galbi');
                    updateQuantityDisplay('spam');
                }
            })
            .catch(error => {
                console.error("ì¥ë°”êµ¬ë‹ˆ ë™ê¸°í™” ì‹¤íŒ¨:", error);
                // í´ë°±: ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ê°’ ì‚¬ìš©
                cart.galbi = /*[[${cart.galbiQuantity}]]*/ 0;
                cart.spam = /*[[${cart.spamQuantity}]]*/ 0;

                updateCartDisplay();
                updateQuantityDisplay('galbi');
                updateQuantityDisplay('spam');
            });
    }

    function updateCartStatusDisplay() {
        // ê°ˆë¹„ ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ
        const galbiStatus = document.getElementById('galbi-cart-status');
        const galbiCount = document.getElementById('galbi-cart-count');

        if (cart.galbi > 0) {
            galbiCount.textContent = cart.galbi;
            galbiStatus.style.display = 'block';
        } else {
            galbiStatus.style.display = 'none';
        }

        // ìŠ¤íŒ¸ ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ
        const spamStatus = document.getElementById('spam-cart-status');
        const spamCount = document.getElementById('spam-cart-count');

        if (cart.spam > 0) {
            spamCount.textContent = cart.spam;
            spamStatus.style.display = 'block';
        } else {
            spamStatus.style.display = 'none';
        }
    }

    function increaseQuantity(product) {
        if (quantities[product] < 20) {
            quantities[product]++;
            updateQuantityDisplay(product);
        }
    }

    function decreaseQuantity(product) {
        if (quantities[product] > 0) {
            quantities[product]--;
            updateQuantityDisplay(product);
        }
    }

    function updateQuantityDisplay(product) {
        document.getElementById(product + '-quantity').textContent = quantities[product];
        document.getElementById(product + '-add-btn').disabled = quantities[product] === 0;
    }

    function updateCartDisplay() {
        const totalItems = cart.galbi + cart.spam;
        const cartCountElement = document.getElementById('cart-count');
        const cartBtnElement = document.getElementById('cart-btn');

        if (cartCountElement) {
            cartCountElement.textContent = totalItems;
            cartCountElement.classList.add('cart-count-animation');
            setTimeout(() => {
                cartCountElement.classList.remove('cart-count-animation');
            }, 500);
        }

        if (cartBtnElement) {
            cartBtnElement.disabled = totalItems === 0;
        }
    }

    function addToCart(product) {
        console.log("=== addToCart í•¨ìˆ˜ ì‹¤í–‰ ===");
        console.log("ìƒí’ˆ:", product);
        console.log("ì¶”ê°€í•  ìˆ˜ëŸ‰:", quantities[product]);

        if (quantities[product] > 0) {
            const button = document.getElementById(product + '-add-btn');
            const originalText = button.querySelector('.original-text');
            const qtyToAdd = quantities[product];

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            button.classList.add('btn-loading');
            button.disabled = true;
            originalText.textContent = 'ì¶”ê°€ ì¤‘...';

            // REST API í˜¸ì¶œ
            const formData = new FormData();
            formData.append('galbiQuantity', product === 'galbi' ? qtyToAdd : 0);
            formData.append('spamQuantity', product === 'spam' ? qtyToAdd : 0);
            formData.append('action', 'add');

            fetch('/api/cart/modify', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.status === 401) {
                        // ì¸ì¦ ì˜¤ë¥˜ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        location.href = '/login';
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success) {
                        // ì„±ê³µí•˜ë©´ ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                        cart[product] += qtyToAdd;
                        quantities[product] = 0;

                        updateQuantityDisplay(product);
                        updateCartDisplay();
                        updateCartStatusDisplay();

                        // ì„±ê³µ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                        const productName = product === 'galbi' ? 'ê°ˆë¹„ ì„ ë¬¼ì„¸íŠ¸' : 'ìŠ¤íŒ¸ ì„ ë¬¼ì„¸íŠ¸';
                        showToast(`${productName} ${qtyToAdd}ê°œê°€ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                    } else {
                        showToast(data?.message || 'ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                })
                .finally(() => {
                    // ë¡œë”© ìƒíƒœ í•´ì œ
                    button.classList.remove('btn-loading');
                    button.disabled = quantities[product] === 0;
                    originalText.textContent = 'ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€';
                });
        } else {
            showToast('ìˆ˜ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', 'error');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = toast.querySelector('.toast-message');
        const toastIcon = toast.querySelector('.toast-icon');

        toastMessage.textContent = message;
        toastIcon.textContent = type === 'success' ? 'âœ“' : 'âœ—';

        toast.className = `toast ${type}`;

        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
</body>
</html>